graph TD
A["Todo App (Flutter Web)"]

subgraph L["Shell"]
  L1["Header"]
  L2["Sidebar"]
  L3["Main Panel"]
  L4["Proposal Panel"]
end

A --> L1
A --> L2
A --> L3
A --> L4

subgraph H["Header"]
  H1["Anchor Date Picker"]
  H2["View Switch: Day | Week | Month"]
  H3["Show Completed: Toggle"]
  H4["Search Field"]
  H5["Quick Entry Input"]
  H6["Mode Toggle: Direct | LLM"]
  H7["Primary Button: Add/Propose"]
end

L1 --> H1
L1 --> H2
L1 --> H3
L1 --> H4
L1 --> H5
L1 --> H6
L1 --> H7

H1 -->|select date| R1["Compute range"]
H2 -->|change view| R1
H3 -->|toggle| R2["Set completed filter"]
H4 -->|debounced input| R3["GET /api/todos/search?query"]
H5 -->|text input| R4["Prepare payload"]
H6 -->|switch| R5["Choose mode"]
H7 -->|click| R6{Mode?}
R6 -->|Direct| R7["POST /api/todos"]
R6 -->|LLM| R8["POST /api/llm/propose"]
R7 --> R9["Refresh lists"]
R8 --> L4

subgraph S["Sidebar Smart Lists"]
  S1["Today"]
  S2["Scheduled"]
  S3["All"]
  S4["Flagged (priority==high)"]
  S5["Backlog"]
end

L2 --> S1
L2 --> S2
L2 --> S3
L2 --> S4
L2 --> S5

S1 -->|select| R1
S2 -->|select| R10["GET /api/todos (scheduled only)"]
S3 -->|select| R11["Union of Scheduled + Backlog"]
S4 -->|select| R12["Filter priority==high"]
S5 -->|select| R13["GET /api/todos/backlog"]

subgraph M["Main Panel"]
  M1["Grouped List by Date"]
  M2["Row: Checkbox"]
  M3["Row: Title + Priority Badge"]
  M4["Row Actions: Edit | Delete"]
  M5["Inline Editor: Title, Notes, Date, Priority"]
  M6["Inline Editor Actions: Save | Cancel"]
end

L3 --> M1
M1 --> M2
M1 --> M3
M1 --> M4

M2 -->|toggle| U1["PATCH /api/todos/:id {completed}"]
M4 -->|Edit| M5
M4 -->|Delete| U2["Confirm -> DELETE /api/todos/:id"]
M6 -->|Save| U3["PATCH /api/todos/:id {fields}"]
M6 -->|Cancel| U4["Restore row"]
U1 --> R9
U2 --> R9
U3 --> R9

subgraph P["Proposal Panel (LLM)"]
  P1["Operations List with Checkboxes"]
  P2["Diff for Update/Complete"]
  P3["Button: Apply Selected"]
  P4["Button: Discard"]
end

L4 --> P1
L4 --> P2
L4 --> P3
L4 --> P4

P3 -->|POST /api/llm/apply| R14["Summary counts"]
P4 -->|clear| R15["Hide panel"]
R14 --> R9
R14 --> R15

R1 -->|GET /api/todos?from&to| R9
R2 --> R9
R10 --> R9
R11 --> R9
R12 --> R9
R13 --> R9
R3 --> M1

R9["Refresh scheduled/backlog lists"]